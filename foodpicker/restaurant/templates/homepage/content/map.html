{% extends 'homepage/content/main.html' %}
{% load static %}

{% block content %}

<div class="all-restaurants-map">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <strong>Messages:</strong> {{ message }}
    </div>
    {% endfor %}
    <h1 class="page-title">All Restaurants Map</h1>
    <select id="radiusFilter">
        <option value="2">2 km</option>
        <option value="5" selected>5 km</option>
        <option value="10">10 km</option>
        <option value="15">15 km</option>
        <option value="20">20 km</option>
    </select>
    <div id="map"></div>
    
</div>


<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
    /* Page Container */
    .all-restaurants-map {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 1rem;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        text-align: center;
        z-index: 0;
    }

    /* Title Styling */
    .page-title {
        font-size: 2rem;
        color: #333;
        margin-bottom: 1.5rem;
    }

    /* Map Styling */
    #map {
        height: 650px;
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 0;
    }

    /* Popup Content Styling */
    .popup-content {
        font-size: 0.9rem;
        color: #444;
    }

    .popup-content b {
        font-size: 1rem;
        color: #222;
    }

    .popup-content p {
        margin: 0.5rem 0;
    }

    /* Details Link */
    .details-link {
        display: inline-block;
        margin-top: 0.5rem;
        text-decoration: none;
        color: #04AA6D;
        font-weight: bold;
        border: 1px solid #04AA6D;
        padding: 5px 10px;
        border-radius: 4px;
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .details-link:hover {
        background-color: #04AA6D;
        color: #fff;
    }
</style>

<script>
    var map = L.map('map').setView([2.9252, 101.6414], 12); // Default location
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var userMarker;
    var restaurantMarkers = [];
    var userLat, userLon;

    function fetchRestaurants(radius) {
        if (!userLat || !userLon) {
            console.log("User location not available yet.");
            return;
        }

        fetch(`/restaurants_within_radius/?latitude=${userLat}&longitude=${userLon}&radius=${radius}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Remove existing restaurant markers
            restaurantMarkers.forEach(marker => map.removeLayer(marker));
            restaurantMarkers = [];

            // Add new restaurant markers
            data.restaurants.forEach(restaurant => {
                var marker = L.marker([restaurant.latitude, restaurant.longitude]).addTo(map);
                var popupContent = `
                    <div class="popup-content">
                        <b>${restaurant.name}</b><br>
                        Open: ${restaurant.opentime} - ${restaurant.closetime}<br>
                        Distance: ${restaurant.distance_km.toFixed(2)} km<br>
                        <a href="/restaurant/${restaurant.id}/" class="details-link">View Details</a>
                    </div>
                `;
                marker.bindPopup(popupContent);
                restaurantMarkers.push(marker);
            });
        });
    }

    function fetchNearestRestaurant() {
        fetch(`/nearest_restaurant?latitude=${userLat}&longitude=${userLon}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                console.log("Nearest Restaurant:", data);
                alert(`Nearest restaurant: ${data.name}, Distance: ${data.distance_km.toFixed(2)} km`);
            }
        });
    }

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
            userLat = position.coords.latitude;
            userLon = position.coords.longitude;
            map.setView([userLat, userLon], 14);

            // Set user location marker
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker([userLat, userLon]).addTo(map)
                .bindPopup("<b>Your Location</b>")
                .openPopup();

            fetchNearestRestaurant();
            fetchRestaurants(5); // Default radius: 5km
        }, () => {
            alert("Geolocation permission denied. Using default location.");
        });
    } else {
        alert("Geolocation is not supported by this browser.");
    }

    // Update restaurant markers when radius changes
    document.getElementById("radiusFilter").addEventListener("change", function () {
        fetchRestaurants(this.value);
    });
</script>




{% endblock %}
